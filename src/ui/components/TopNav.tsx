import clsx from 'clsx';
import { BarChart3, BookOpen, FileText, FolderOpen, GitBranch, LayoutGrid } from 'lucide-react';
import * as DropdownMenu from '@radix-ui/react-dropdown-menu';
import type { ReactNode } from 'react';

export type Mode = 'demo' | 'repo' | 'docs' | 'dashboard';

export function TopNav(props: {
  mode: Mode;
  onModeChange: (mode: Mode) => void;
  repoPath?: string | null;
  onOpenRepo: () => void;
  onImportSession?: () => void;
  onImportKimiSession?: () => void;
  onImportAgentTrace?: () => void;
  importEnabled?: boolean;
  children?: ReactNode;
}) {
  const {
    mode,
    onModeChange,
    repoPath,
    onOpenRepo,
    onImportSession,
    onImportKimiSession,
    onImportAgentTrace,
    importEnabled,
    children
  } = props;

  const Tab = (p: { id: Mode; label: string; icon: ReactNode }) => (
    <button
      role="tab"
      aria-selected={mode === p.id}
      tabIndex={mode === p.id ? 0 : -1}
      className={clsx(
        'inline-flex items-center gap-2 rounded-md px-3 py-1.5 text-sm font-medium transition-all duration-150',
        mode === p.id
          ? 'bg-bg-card text-text-primary shadow-sm'
          : 'text-text-tertiary hover:bg-bg-hover hover:text-text-secondary hover:scale-[1.02] active:scale-95'
      )}
      onClick={() => onModeChange(p.id)}
      type="button"
    >
      {p.icon}
      <span>{p.label}</span>
    </button>
  );

  const handleTabKeyDown = (event: React.KeyboardEvent<HTMLDivElement>) => {
    if (!['ArrowLeft', 'ArrowRight', 'Home', 'End'].includes(event.key)) return;
    event.preventDefault();
    const order: Mode[] = ['demo', 'repo', 'dashboard', 'docs'];
    const currentIndex = order.indexOf(mode);
    if (currentIndex === -1) return;
    if (event.key === 'Home') {
      onModeChange(order[0]);
      return;
    }
    if (event.key === 'End') {
      onModeChange(order[order.length - 1]);
      return;
    }
    const delta = event.key === 'ArrowRight' ? 1 : -1;
    const nextIndex = (currentIndex + delta + order.length) % order.length;
    onModeChange(order[nextIndex]);
  };

  return (
    <div className="flex items-center justify-between border-b border-border-light bg-bg-card px-4 py-3">
      <div className="flex items-center gap-3">
        <div className="text-sm font-bold tracking-wide text-text-primary">Narrative</div>
        <div
          className="flex items-center gap-1 bg-bg-page rounded-lg p-1"
          role="tablist"
          aria-label="View mode"
          onKeyDown={handleTabKeyDown}
        >
          <Tab id="demo" label="Demo" icon={<LayoutGrid className="h-4 w-4" />} />
          <Tab id="repo" label="Repo" icon={<GitBranch className="h-4 w-4" />} />
          <Tab id="dashboard" label="Dashboard" icon={<BarChart3 className="h-4 w-4" />} />
          <Tab id="docs" label="Docs" icon={<BookOpen className="h-4 w-4" />} />
        </div>
      </div>

      <div className="flex items-center gap-3">
        {repoPath ? (
          <div className="max-w-[44ch] truncate text-xs text-text-muted" title={repoPath}>
            {repoPath}
          </div>
        ) : null}

        {mode === 'repo' && (
          <ImportMenu
            onImportSession={onImportSession}
            onImportKimiSession={onImportKimiSession}
            onImportAgentTrace={onImportAgentTrace}
            importEnabled={importEnabled}
          />
        )}

        {children}

        <button
          type="button"
          className="inline-flex items-center gap-2 rounded-lg bg-accent-blue px-3 py-1.5 text-sm font-medium text-accent-foreground hover:brightness-95 transition-all"
          onClick={onOpenRepo}
        >
          <FolderOpen className="h-4 w-4" />
          Open repo…
        </button>
      </div>
    </div>
  );
}

function ImportMenu(props: {
  onImportSession?: () => void;
  onImportKimiSession?: () => void;
  onImportAgentTrace?: () => void;
  importEnabled?: boolean;
}) {
  const { onImportSession, onImportKimiSession, onImportAgentTrace, importEnabled } = props;

  if (!onImportSession && !onImportKimiSession && !onImportAgentTrace) return null;

  return (
    <DropdownMenu.Root>
      <DropdownMenu.Trigger asChild>
        <button
          type="button"
          disabled={!importEnabled}
          className={clsx(
            'inline-flex items-center gap-2 rounded-lg px-3 py-1.5 text-sm font-medium transition-colors',
            importEnabled
              ? 'bg-bg-page text-text-secondary hover:bg-border-light'
              : 'bg-bg-subtle text-text-muted cursor-not-allowed'
          )}
        >
          <FileText className="h-4 w-4" />
          Import data…
        </button>
      </DropdownMenu.Trigger>

      <DropdownMenu.Portal>
        <DropdownMenu.Content
          align="end"
          sideOffset={8}
          className={clsx(
            'z-50 w-56 rounded-xl border border-border-light bg-bg-card p-1 shadow-lg',
            'data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0',
            'data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95'
          )}
        >
          {onImportSession && (
            <DropdownMenu.Item
              onSelect={onImportSession}
              className={clsx(
                'flex w-full cursor-pointer select-none items-center gap-2 rounded-lg px-3 py-2 text-sm outline-none transition-colors text-left',
                'text-text-secondary',
                'data-[highlighted]:bg-bg-hover data-[highlighted]:text-text-primary'
              )}
            >
              Import session JSON…
            </DropdownMenu.Item>
          )}
          {onImportKimiSession && (
            <DropdownMenu.Item
              onSelect={onImportKimiSession}
              className={clsx(
                'flex w-full cursor-pointer select-none items-center gap-2 rounded-lg px-3 py-2 text-sm outline-none transition-colors text-left',
                'text-text-secondary',
                'data-[highlighted]:bg-bg-hover data-[highlighted]:text-text-primary'
              )}
            >
              Import Kimi log…
            </DropdownMenu.Item>
          )}
          {onImportAgentTrace && (
            <DropdownMenu.Item
              onSelect={onImportAgentTrace}
              className={clsx(
                'flex w-full cursor-pointer select-none items-center gap-2 rounded-lg px-3 py-2 text-sm outline-none transition-colors text-left',
                'text-text-secondary',
                'data-[highlighted]:bg-bg-hover data-[highlighted]:text-text-primary'
              )}
            >
              Import Agent Trace…
            </DropdownMenu.Item>
          )}
        </DropdownMenu.Content>
      </DropdownMenu.Portal>
    </DropdownMenu.Root>
  );
}
