import redactionPatterns from '../../shared/redaction-patterns.json';

export type RedactionHit = { type: string; count: number };

export type RedactionResult = {
  redacted: string;
  hits: RedactionHit[];
};

/**
 * Very small, heuristic scrubbing.
 * Goal: prevent accidentally committing secrets into `.narrative/`.
 *
 * Expand as needed.
 */
type RedactionPatternConfig = {
  kind: string;
  pattern: string;
  flags?: string;
};

const compiledPatterns: Array<{ type: string; re: RegExp }> = (
  redactionPatterns as RedactionPatternConfig[]
).map((pattern) => {
  const baseFlags = pattern.flags ?? '';
  const flags = baseFlags.includes('g') ? baseFlags : `${baseFlags}g`;
  return {
    type: pattern.kind,
    re: new RegExp(pattern.pattern, flags)
  };
});

export function redactSecrets(input: string): RedactionResult {
  let redacted = input;
  const hits: RedactionHit[] = [];

  for (const p of compiledPatterns) {
    const matches = redacted.match(p.re);
    if (!matches || matches.length === 0) continue;
    hits.push({ type: p.type, count: matches.length });
    redacted = redacted.replace(p.re, `[REDACTED:${p.type}]`);
  }

  return { redacted, hits };
}
